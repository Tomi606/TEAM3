<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="kr.kh.team3.dao.HospitalDAO">
	<insert id="insertHospital">
		insert into hospital(ho_id, ho_pw, ho_email, ho_name, ho_ceo, ho_hs_num, ho_num, ho_address, ho_phone, ho_authority, ho_ms_state) 
		values(#{ho.ho_id}, #{ho.ho_pw}, #{ho.ho_email}, #{ho.ho_name}, #{ho.ho_ceo}, 
				#{ho.ho_hs_num}, #{ho.ho_num}, #{address}, #{ho.ho_phone},"MANAGER","가입대기")
	</insert>
	
	<insert id="insertSiteHospital">
		insert into site_management(site_la_num, site_id, site_email, site_phone, site_authority)
		value(1, #{st.site_id}, #{st.site_email}, #{st.site_phone}, "USER")
	</insert>
	
	<select id="selectHospitalId" resultType="HospitalVO">
		select * from hospital where ho_id = #{ho_id}
	</select>
	
	<!-- 정경호 : 과목 ㄱㄴㄷㄹ순으로 정렬을 위해 order by hs_title 추가 -->
	<select id="selectHospitalSubjectList" resultType="HospitalSubjectVO">
		select * from hospital_subject order by hs_title
	</select>
	
	<!-- 로그인 -->
	<select id="selectHospital" resultType="kr.kh.team3.model.vo.HospitalVO">
		SELECT * FROM hospital
		WHERE ho_id = #{ho_id}
	</select>
	
	<select id="selectSite" resultType="kr.kh.team3.model.vo.SiteManagement">
		SELECT * FROM site_management
		WHERE site_id = #{ho_id}
	</select>
	
	<select id="selectSiDoList" resultType="SiDoVO">
		select * from si_do
	</select>
	
	<select id="selectSggList" resultType="SiGoonGuVO">
		select * from si_goon_gu
	</select>
	
	<select id="selectEmdList" resultType="EupMyeonDongVO">
		select * from eup_myeon_dong
	</select>
	
	<update id="updateLoginFail">
		UPDATE hospital
		SET ho_fail = ho_fail + 1
		WHERE ho_id = #{ho_id}
	</update>
	
	<update id="updateLoginFailZero">
		UPDATE hospital
		SET ho_fail = 0
		WHERE ho_id = #{ho_id}
	</update>
	
	<!-- 사이트 매니지먼트 아이디, 이메일, 폰 중복 체크 -->
	<select id="selectSiteId" resultType="kr.kh.team3.model.vo.SiteManagement">
		select * from site_management where site_id = #{site_id}
	</select>
	
	<select id="selectHospitalEmail" resultType="kr.kh.team3.model.vo.SiteManagement">
		select * from site_management where site_email = #{site_email}
	</select>
	
	<select id="selectHospitalPhone" resultType="kr.kh.team3.model.vo.SiteManagement">
		select * from site_management where site_phone = #{site_phone}
	</select>
	
	<!-- 정경호 이용중인 병원만 조회하는 쿼리 -->
	<select id="hospitalList" resultType="HospitalVO">
		select * from hospital where ho_ms_state = "이용중"
		order by ho_id
		limit #{cri.pageStart}, #{cri.perPageNum}
	</select>
		
	<select id="selectHospitalCount" resultType="int">
		select count(*) from hospital where ho_ms_state = "이용중"
	</select>
	<!-- 정경호 끝 -->
	
	<!-- 관리자 병원 관리 -->
	<select id="selectWaitHospitalList" resultType="kr.kh.team3.model.vo.HospitalVO">
		select * from hospital
		where ho_ms_state = "가입대기"
		order by ho_id
		limit #{cri.pageStart}, #{cri.perPageNum}
	</select>
	
	<select id="selectWHTotalCount" resultType="int">
		select count(*) from hospital where ho_ms_state = "가입대기"
	</select>
	
	<update id="updateWaitOk">
		update hospital
		set ho_ms_state = "이용중"
		where ho_id = #{ho_id}
	</update>
	
	<delete id="updateWaitNo">
		delete from hospital
		where ho_id = #{ho_id}
	</delete>
	
	<delete id="deleteHospital">
		delete from hospital
		where ho_id = #{ho_id}
	</delete>
	
	<delete id="deleteSite">
		delete from site_management
		where site_id = #{ho_id}
	</delete>
	
	<resultMap type="kr.kh.team3.model.vo.ReportVO" id="ReportMap">
		<result property="rp_num" column="rp_num"/>
		<result property="rp_target" column="rp_target"/>
		<result property="rp_name" column="rp_name"/>
		<result property="rp_rs_name" column="rp_rs_name"/>
		<result property="rp_site_num" column="rp_site_num"/>
		<collection property="hospital" ofType="kr.kh.team3.model.vo.HospitalVO"
			column="rp_target" select="selectHospitalReport"/>
	</resultMap>
	
	<select id="selectHospitalReport" resultType="kr.kh.team3.model.vo.HospitalVO">
		select * from hospital where ho_id = #{rp_target}
	</select>
	
	<select id="selectReportHospitalList" resultMap="ReportMap">
		select * from report
		order by rp_target
		limit #{cri.pageStart}, #{cri.perPageNum}
	</select>
	
	<select id="selectRHTotalCount" resultType="int">
		select count(*) from report
		order by rp_target
	</select>
	
	<update id="updateHospitalStop">
		update hospital set
		ho_stop = DATE_ADD(NOW(), INTERVAL #{rp_rs_name} DAY),
		ho_ms_state = "기간정지"
		where ho_id = #{ho_id}
	</update>
	
	<update id="updateHospitalStopPlus">
		update hospital set
		ho_stop = DATE_ADD(ho_stop, INTERVAL #{rp_rs_name} DAY),
		ho_ms_state = "기간정지"
		where ho_id = #{ho_id}
	</update>
	
	<update id="updateHoStopCancel">
		update hospital set
		ho_stop = null,
		ho_ms_state = "이용중"
		where ho_id = #{ho_id}
	</update>
	
	<!-- 병원 페이지 : 선진, 민석 -->
<!-- 	<select id="selectHospitalSubjectList" resultType="HospitalSubjectVO">
		select * from hospital_subject where ho_id = #{ho_id}
	</select> -->
	
	<select id="selectReservationScheduleList" resultType="kr.kh.team3.model.vo.ReservationScheduleVO">
			select * from reservation_schedule;
	</select>
	
	<select id="selectReservationScheduleTimeList" resultType="kr.kh.team3.model.vo.ReservationScheduleVO">
			select * from reservation_schedule where rs_date = #{rs_date}
  </select>
  
	<insert id="insertOrUpdateHospitalDetail" parameterType="HospitalDetailVO">
		insert into hospital_detail(hd_ho_id, hd_hs_num, hd_info, hd_time, hd_park, hd_announce, hd_etc, hd_subject_detail)
		values (#{hd.hd_ho_id}, #{hd.hd_hs_num}, #{hd.hd_info}, #{hd.hd_time}, #{hd.hd_park}, #{hd.hd_announce}, #{hd.hd_etc}, #{hd.hd_subject_detail})
		on duplicate key update 
		hd_ho_id = values(hd_ho_id), 
		hd_hs_num = values(hd_hs_num), 
		hd_info = values(hd_info), 
		hd_time = values(hd_time), 
		hd_park = values(hd_park), 
		hd_announce = values(hd_announce), 
		hd_etc = values(hd_etc), 
		hd_subject_detail = values(hd_subject_detail)
	</insert>
	
	<delete id="deleteHospitalDetail" parameterType="String">
		delete from hospital_detail where hd_ho_id = #{hd_ho_id}
	</delete>
	
	<select id="selectHospitalInfo" resultType="HospitalVO">
		select * from hospital
	</select>
	
	<select id="selectSelectedSubject" resultType="HospitalSubjectVO">
		select * from hospital_subject where hs_num = #{detail.hd_hs_num}
	</select>
	
	<select id="selectHoDetail" resultType="HospitalDetailVO">
		select * from hospital_detail where hd_ho_id = #{hospital.ho_id}
		order by hd_num desc limit 1
	</select>
</mapper>
